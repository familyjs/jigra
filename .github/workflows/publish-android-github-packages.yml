name: Publish Native Android Library (GitHub Packages)

on:
  workflow_call:
    secrets:
      JIG_GH_AUTHOR:
        required: true
      JIG_GH_RELEASE_TOKEN:
        required: true
  workflow_dispatch:

jobs:
  build:

    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: '5.x'
        token: ${{ secrets.JIG_GH_RELEASE_TOKEN }}

    - name: Set up info
      run: |
        sed -i "s/JIG_AUTHOR/'${{ secrets.JIG_GH_AUTHOR }}'/g" ./scripts/publish-module.gradle && \
        sed -i "s/JIG_RELEASE_TOKEN/'${{ secrets.JIG_GH_RELEASE_TOKEN }}'/g" ./scripts/publish-module.gradle
      working-directory: ./android

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'zulu'
        server-id: github # Value of the distributionManagement/repository/id field of the pom.xml
        settings-path: ${{ github.workspace }} # location for the settings.xml file

    - name: Grant execute permission for gradlew
      run: chmod +x ./android/gradlew
    - name: Grant execute permission for publishing script
      run: chmod +x ./scripts/publish-android.sh

    # The USERNAME and TOKEN need to correspond to the credentials environment variables used in
    # the publishing section of your build.gradle
    - name: Run publish script
      run: ./publish-android.sh
      working-directory: ./scripts
      env:
        USERNAME: ${{ github.actor }}
        TOKEN: ${{ secrets.JIG_GH_RELEASE_TOKEN }}
